import fs from 'fs'; import path from 'path'; import fetch from 'node-fetch'; import pdf from 'pdf-parse'; import { google } from 'googleapis'; import { makeOAuthClient } from './gmail_oauth.js'; const OUT='./store/pdfs'; const END=process.env.APP_PARSE_URL||'http://localhost:3040/suppliers/parse_deep_cascade'; async function run(){ fs.mkdirSync(OUT,{recursive:true}); const tok=JSON.parse(fs.readFileSync('./store/gmail_tokens.json','utf8')); const o=makeOAuthClient(); o.setCredentials(tok); const gmail=google.gmail({version:'v1',auth:o}); const list=await gmail.users.messages.list({userId:'me',maxResults:10}); const msgs=list.data.messages||[]; for(const m of msgs){ const msg=await gmail.users.messages.get({userId:'me',id:m.id,format:'full'}); const parts=(msg.data.payload.parts||[]).flatMap(p=>p.parts||[p]); for(const p of parts){ const mt=(p.mimeType||'').toLowerCase(); if(!mt.includes('pdf')) continue; let bytes; if(p.body.attachmentId){ const att=await gmail.users.messages.attachments.get({userId:'me',messageId:m.id,id:p.body.attachmentId}); bytes=Buffer.from(att.data.data,'base64'); } else if(p.body.data){ bytes=Buffer.from(p.body.data,'base64'); } else continue; const file=`gmail_${m.id}_${Date.now()}.pdf`; const fp=path.join(OUT,file); fs.writeFileSync(fp,bytes); const txt=await pdf(bytes).then(d=>d.text||''); fs.writeFileSync(fp.replace(/\.pdf$/i,'.txt'),txt); const from=(msg.data.payload.headers||[]).find(h=>h.name==='From'); const vendor=(from && String(from.value||'').split('@')[1]||'unknown').split('.')[0].toUpperCase(); const r=await fetch(END,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({vendor,filename:file})}); console.log('processed', file, await r.text()); } } } if (require.main===module){ run().catch(e=>{ console.error(e); process.exit(1); }); }
